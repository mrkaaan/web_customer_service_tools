## 基本结构

### 0. `manifest.json` （扩展配置文件）

是Chrome扩展的核心配置文件，它定义了扩展的基本信息、权限和其他设置。

### 1. `background.js`（后台脚本）

**作用：**
- **长期运行的任务**：后台脚本是唯一可以在浏览器关闭所有标签页后继续运行的脚本。它通常用于执行需要持续进行的任务，如监听WebSocket连接、定时任务等。
- **全局状态管理**：它可以存储和管理整个扩展的状态信息，比如用户的设置或与服务器之间的会话信息。
- **事件监听器**：负责监听来自内容脚本和用户界面（如弹出窗口）的消息，并根据这些消息采取行动。
- **跨页面通信枢纽**：作为不同部分（如内容脚本和弹出窗口）之间的桥梁，传递信息。

**在这个项目中的具体职责：**
- 连接到WebSocket服务器并保持连接。
- 监听从WebSocket服务器接收到的消息，并向所有打开的淘工厂页面发送通知。
- 接收来自内容脚本的注册请求，并通过WebSocket向服务器注册当前浏览器实例。
- 处理新消息的通知，并更新悬浮窗的内容。

### 2. `content.js`（内容脚本）

**作用：**
- **网页内交互**：内容脚本被注入到特定网页中，可以访问该网页的DOM元素和JavaScript环境。它主要用于修改网页内容或监听网页上的变化。
- **监控网页行为**：例如，监听特定元素的变化，检测新消息的出现等。
- **与后台脚本通信**：可以通过`chrome.runtime.sendMessage()`向后台脚本发送消息，报告网页上的重要事件。

**在这个项目中的具体职责：**
- 监控淘工厂网页上指定元素的变化，检测是否有新消息。
- 当检测到新消息时，通知后台脚本。
- 在启动时向后台脚本发送注册请求，标识当前浏览器实例。

### 3. `popup.js`（弹出窗口脚本）

**作用：**
- **用户界面逻辑**：负责处理用户与扩展弹出窗口（即悬浮窗）之间的交互。它控制显示什么信息给用户以及如何响应用户的操作。
- **显示动态内容**：可以根据后台脚本提供的数据动态更新其内容，例如显示最新的消息列表。
- **与后台脚本通信**：监听后台脚本发送的消息，并根据这些消息更新UI；也可以通过点击事件等方式向后台脚本发送指令。

**在这个项目中的具体职责：**
- 显示来自其他浏览器实例的新消息。
- 允许用户点击某条消息来聚焦对应的浏览器窗口。
- 监听后台脚本发送的新消息通知，并更新UI以反映最新消息。

### 总结

这三个脚本之间通过`chrome.runtime.sendMessage()`和`chrome.runtime.onMessage.addListener()`方法进行通信。以下是它们的工作流程：

1. **内容脚本**监听网页上的变化，并在发现新消息时通知**后台脚本**。
2. **后台脚本**接收内容脚本的消息，并通过WebSocket广播给其他已连接的客户端。
3. 当有新的消息时，**后台脚本**也会通知**弹出窗口脚本**，以便更新悬浮窗的内容。
4. 用户可以通过点击悬浮窗中的消息来聚焦对应的浏览器窗口，这一操作由**弹出窗口脚本**处理。

## manifest.json配置项

### `host_permissions`

这个配置项定义了扩展程序可以访问的网络资源。它允许扩展在特定的主机（或一组主机）上执行某些操作，比如发送网络请求、使用 `chrome.cookies` API 等。这些权限是必要的，因为 Chrome 扩展的安全模型默认情况下不允许访问任意网站的数据，除非明确声明了对这些网站的访问权限。

- **为什么需要 `host_permissions`**：当你希望你的扩展能够在某些特定的域名下工作，或者与这些域名进行交互（如发起跨域请求），你需要声明这些权限。这样不仅提升了安全性，也使得用户在安装扩展时能够清楚地知道它将访问哪些网站。

### `content_scripts`

这个配置项用于指定内容脚本（Content Scripts），即那些注入到匹配 URL 模式的网页中的 JavaScript 文件。内容脚本可以直接访问和修改页面的 DOM，因此非常适合用来增强或改变网页的行为。

- **为什么需要 `content_scripts`**：如果你想要你的扩展能在某些特定的网页上运行自定义代码（例如添加功能按钮、修改样式等），你需要通过 `content_scripts` 来声明这些脚本以及它们应该应用到哪些页面。

### 两者之间的关系

虽然 `host_permissions` 和 `content_scripts` 可以有重叠的 URL 模式，但这并不意味着它们是重复的。实际上，`content_scripts` 的 `matches` 属性定义了内容脚本将在哪些页面上自动加载，而 `host_permissions` 则赋予了扩展访问这些页面的能力。如果你的内容脚本需要与页面进行互动（如读取或修改DOM），那么相应的 `host_permissions` 是必须的；否则，可能会遇到权限不足的问题。

### 关于 `urls.json` 和 `web_accessible_resources`

引入 `urls.json` 文件是为了简化背景脚本中 URL 列表的管理。这样做有几个好处：

1. **集中管理**：所有 URL 都存放在一个地方，便于维护。
2. **减少冗余代码**：避免在多个地方重复定义相同的 URL。
3. **动态加载**：可以通过 `fetch` 动态获取 URL 列表，这可能对于那些需要频繁更新的 URL 特别有用。

至于 `web_accessible_resources`，这是为了让扩展内的资源（如 `urls.json`）可以被网页或其他扩展部分访问。这是因为默认情况下，扩展内部的文件不能直接从网页中加载。将 `urls.json` 加入此列表后，你可以确保它可以在需要的地方被正确引用和读取。

### 总结

- **`host_permissions`** 是为了授予扩展访问特定网站的权限。
- **`content_scripts`** 是为了指定哪些脚本应该注入到哪些页面中。
- **`urls.json` 和 `web_accessible_resources`** 是为了更好地管理和访问扩展内部的资源文件。

因此，尽管 `host_permissions` 和 `content_scripts` 中的 URL 模式可能看起来相似，但它们各自服务的目的不同，且都是构建功能健全的 Chrome 扩展所必需的。


## 需求

cookie隔离实现单个浏览器操作
浏览器页签闪动提示
添加快捷键跳转到悬浮窗上首位消息存在的页签
禁用原本ctrl+w关闭浏览器窗口的功能
给ctrl+w添加新的标注功能